# Data Model: RAG Spec-4 Frontend-Backend Integration

## Overview
Data models for the frontend-backend integration system that connects the Docusaurus chat component with the FastAPI backend for RAG agent communication.

## Entity: User Query
**Description**: A query submitted by the user containing their question and optional selected text context
**Fields**:
- `query_text` (string): The user's question or request text
- `selected_text` (string, optional): Text selected from book pages for context
- `context_metadata` (object, optional): Additional context information:
  - `page_url` (string): URL of the page where text was selected
  - `page_title` (string): Title of the page where text was selected
  - `module` (string): Module or section where text was selected
  - `position_start` (integer): Starting character position of selection
  - `position_end` (integer): Ending character position of selection
- `user_preferences` (object, optional): User preferences for the response:
  - `temperature` (float): Temperature setting for response generation (0.0 to 1.0)
  - `max_tokens` (integer): Maximum tokens for the response
  - `include_sources` (boolean): Whether to include source references in the response

**Validation rules**:
- `query_text` must not be empty
- `selected_text` if provided must be a string
- `context_metadata.page_url` must be a valid URL if provided
- `position_start` must be non-negative if provided
- `position_end` must be greater than or equal to `position_start` if provided
- `temperature` must be between 0.0 and 1.0 if provided
- `max_tokens` must be positive if provided

## Entity: Agent Response
**Description**: The response generated by the RAG agent based on the user query and selected context
**Fields**:
- `response_text` (string): The agent's generated answer text
- `sources` (array of objects): Array of source references used in the response:
  - `text` (string): Snippet of the source text
  - `url` (string): URL to the source content
  - `page` (string): Page or module reference
  - `similarity_score` (float): Similarity score of the source chunk (0.0 to 1.0)
- `confidence_score` (float): Confidence level in the response accuracy (0.0 to 1.0)
- `processing_time_ms` (float): Time taken to generate the response in milliseconds
- `conversation_id` (string): Unique identifier for the conversation thread
- `retrieval_details` (object): Details about the retrieval process:
  - `chunks_retrieved` (integer): Number of content chunks retrieved
  - `execution_time_ms` (float): Time taken for retrieval in milliseconds
  - `collection_name` (string): Name of the collection searched
  - `top_k_requested` (integer): Number of results requested

**Validation rules**:
- `response_text` must not be empty
- `confidence_score` must be between 0.0 and 1.0
- `processing_time_ms` must be positive
- `sources` array elements must have valid URL and text fields
- `retrieval_details.chunks_retrieved` must be non-negative

## Entity: Chat Message
**Description**: A message in the conversation history between user and agent
**Fields**:
- `message_id` (string): Unique identifier for the message
- `sender` (string): Who sent the message ('user' or 'agent')
- `content` (string): The message content (query or response)
- `timestamp` (datetime): When the message was created
- `metadata` (object, optional): Additional metadata for the message:
  - `selected_text` (string): For user messages, text that was selected
  - `context_page` (string): For user messages, page where text was selected
  - `source_references` (array of objects): For agent messages, source references
  - `confidence_score` (float): For agent messages, response confidence
- `status` (string): Message processing status ('sent', 'delivered', 'read', 'error')

**Validation rules**:
- `message_id` must be unique within the conversation
- `sender` must be either 'user' or 'agent'
- `content` must not be empty
- `timestamp` must be in ISO 8601 format
- `status` must be one of the allowed values

## Entity: Text Selection
**Description**: Captured text selection from book pages with position and context metadata
**Fields**:
- `selection_id` (string): Unique identifier for the text selection
- `text` (string): The selected text content
- `page_url` (string): URL of the page where text was selected
- `page_title` (string): Title of the page where text was selected
- `module` (string): Module or section where text was selected
- `position_start` (integer): Starting character position of the selection in the page
- `position_end` (integer): Ending character position of the selection in the page
- `timestamp` (datetime): When the selection was made
- `word_count` (integer): Number of words in the selected text

**Validation rules**:
- `text` must not be empty
- `page_url` must be a valid URL
- `position_start` must be non-negative
- `position_end` must be greater than or equal to `position_start`
- `word_count` must be positive
- `timestamp` must be in ISO 8601 format

## Entity: API Request
**Description**: The structure of requests from frontend to backend API
**Fields**:
- `query` (string): The user's query text
- `selected_text` (string, optional): Text selected from book pages for context
- `context_metadata` (object, optional): Context information for the query:
  - `page_url` (string): URL of the page where text was selected
  - `page_title` (string): Title of the page where text was selected
  - `module` (string): Module where text was selected
  - `position_start` (integer): Starting position of selection
  - `position_end` (integer): Ending position of selection
- `user_preferences` (object, optional): User preferences for response:
  - `max_tokens` (integer): Maximum tokens for response (default: 500)
  - `temperature` (float): Temperature for response generation (default: 0.7)
  - `include_sources` (boolean): Whether to include sources (default: true)

**Validation rules**:
- `query` must not be empty
- `context_metadata.page_url` must be a valid URL if provided
- `user_preferences.max_tokens` must be positive if provided
- `user_preferences.temperature` must be between 0.0 and 1.0 if provided

## Entity: API Response
**Description**: The structure of responses from backend to frontend API
**Fields**:
- `success` (boolean): Whether the request was processed successfully
- `answer` (string): The generated answer to the user's query
- `sources` (array of objects, optional): Source references for the answer:
  - `text` (string): Snippet of the source content
  - `url` (string): URL to the source
  - `page` (string): Page reference
  - `similarity_score` (float): Similarity score (0.0 to 1.0)
- `confidence` (float): Confidence score in the response (0.0 to 1.0)
- `retrieval_stats` (object): Statistics about the retrieval process:
  - `chunks_retrieved` (integer): Number of chunks retrieved
  - `processing_time_ms` (float): Processing time in milliseconds
- `query_id` (string): Unique identifier for the query
- `error` (object, optional): Error information if the request failed:
  - `type` (string): Type of error
  - `message` (string): Error message
  - `code` (string): Error code

**Validation rules**:
- `success` must be boolean
- If `success` is true, `answer` must not be empty
- `confidence` must be between 0.0 and 1.0
- `retrieval_stats.processing_time_ms` must be positive if provided
- If `success` is false, `error` must be provided with type, message, and code

## Entity: Health Status
**Description**: Health check response for the integration service
**Fields**:
- `status` (string): Overall service status ('healthy', 'degraded', 'unavailable')
- `timestamp` (datetime): When the health check was performed
- `services` (object): Status of dependent services:
  - `frontend` (string): Frontend connection status ('connected', 'disconnected')
  - `backend` (string): Backend service status ('connected', 'disconnected')
  - `rag_agent` (string): RAG agent service status ('connected', 'disconnected')
- `response_time_ms` (float): Response time of the health check in milliseconds

**Validation rules**:
- `status` must be one of 'healthy', 'degraded', or 'unavailable'
- `response_time_ms` must be positive
- `timestamp` must be in ISO 8601 format
- All service status values must be one of the allowed states